<!DOCTYPE html>
<html>

<head>
    <style>
    body {
        font-family: sans-serif;
    }

    .ds-dashboard-widgets {
        width: 20%;
        margin: 10px;
        padding: 10px;
        float: left;
        border: 1px solid #ccc;
        text-align: center;
    }

    .ds-dashboard-widgets .stat, .ds-dashboard-widgets .stat-title{
        display: block;
    }
    </style>
</head>

<body>

    <div class="ds-dashboard-widgets" data-lat="-78.4644904" data-lon="106.8317842">
        <p>
            <span class="stat temperature">&#160;</span>
            <span class="stat-title">Current temperature in Antarctica</span>
        </p>
        <p>
            <span class="stat wind_speed">&#160;</span>
            <span class="stat-title">Current windspeed in Antarctica</span>
        </p>
    </div>
    <div class="ds-dashboard-widgets">
        <p>
            <span class="stat time" data-timezone="-3">&#160;</span>
            <span class="stat-title">Current time in Antarctica</span>
        </p>
        <p>
            <span id="set-one" data-countdown="nov 10 2015 14:30:35"></span>
            <span class="stat-title">Duration</span>
        </p>
    </div>
    <div class="ds-dashboard-widgets effort" id="set-one-effort">
        <p>
            <span class="stat calories" data-calories ="10000">&#160;</span>
            <span class="stat-title">Calories burnt</span>
        </p>
        <p>
            <span class="stat steps" data-steps ="23000">&#160;</span>
            <span class="stat-title">Steps taken</span>
        </p>
    </div>

    <script>
        (function() {
            'use strict';

            var timezone = function() {

                    var timezoneElements = document.querySelectorAll("[data-timezone]");

                    if (timezoneElements.length) {
                        var
                            SECOND = 1000,
                            MINUTE = 60 * SECOND,
                            HOUR = 60 * MINUTE,
                            DAY = 24 * HOUR;

                        var uniformNumber = function(n) {
                            if (n < 10) n = '0' + n;

                            return n;
                        };

                        for (var i in timezoneElements) {
                            if (timezoneElements.hasOwnProperty(i)) {
                                var timezone = parseInt(timezoneElements[i].getAttribute('data-timezone'));
                                var currentTime = new Date();
                                var offsetTime = currentTime.getTime();
                                offsetTime += currentTime.getTimezoneOffset() * MINUTE; // Get UTC
                                offsetTime += timezone * HOUR; // Add timezone offset
                                offsetTime = new Date(offsetTime); // Convert back to date

                                timezoneElements[i].innerHTML = uniformNumber(offsetTime.getHours()) + ':' + uniformNumber(offsetTime.getMinutes());
                            }
                        }
                    }
                },

                countup = function() {

                    var countDownElements = document.querySelectorAll("[data-countdown]");

                    if (countDownElements.length) {
                        var
                            SECOND = 1000,
                            MINUTE = 60 * SECOND,
                            HOUR = 60 * MINUTE,
                            DAY = 24 * HOUR;

                        var uniformNumber = function(n) {
                            if (n < 10) n = '0' + n;

                            return n;
                        };

                        var update = function(UniqueID) {
                            var currentDate = new Date();
                            var duration = currentDate - startDate - DAY;

                            if (duration < 0) duration = 0;


                            var minutesForEffort = Math.floor((duration / 1000) / 60);
                            document.getElementById(UniqueID).setAttribute('data-alapsed', minutesForEffort);

                            var days = parseInt(duration / DAY);
                            duration = duration % DAY;

                            var hours = parseInt(duration / HOUR);
                            duration = duration % HOUR;

                            var minutes = parseInt(duration / MINUTE);
                            duration = duration % MINUTE;

                            var seconds = parseInt(duration / SECOND);

                            document.getElementById(UniqueID).innerHTML = days + ' days ' + hours + ' hours ' + minutes + ' min ' + seconds + ' sec';
                            //set data here
                        };



                        for (var i in countDownElements) {
                            if (countDownElements.hasOwnProperty(i)) {

                                var startDate = new Date(countDownElements[i].getAttribute('data-countdown'));
                                var UniqueID = "timer_" + new Date().getTime().toString();

                                if (!countDownElements[i].id) {
                                    countDownElements[i].id = UniqueID;
                                }

                                var elementID = countDownElements[i].id;

                                if (isNaN(startDate.getTime())) {
                                    return false; // Only proceed if we have a current date
                                }

                                setInterval(update, SECOND, elementID);
                                update(elementID);

                                var effortID = elementID + '-effort';

                                if (document.getElementById(effortID)) {
                                    setInterval(effort, SECOND, elementID, effortID);
                                }
                                effort(elementID, effortID);
                            }

                        }
                    }

                },

                weather = function() {

                    var weatherElements = document.querySelectorAll("[data-lat]");
                    var onJsonLoad = function(data) {
                        var myArr = JSON.parse(data);
                        updateWeather(myArr);
                    };

                    var updateWeather = function(data) {
                        try {
                            var temperature = Math.round(data.main.temp);
                            var wind_speed = data.wind.speed;

                            weatherElements[0].querySelector(".temperature").innerHTML = temperature + '&deg;C';
                            weatherElements[0].querySelector(".wind_speed").innerHTML = wind_speed + 'm/s';
                        } catch (e) {
                            console.log('error', e);
                        }
                    };

                    if (weatherElements.length) {

                        for (var i in weatherElements) {
                            if (weatherElements.hasOwnProperty(i)) {
                                var lat = weatherElements[i].getAttribute('data-lat');
                                var lon = weatherElements[i].getAttribute('data-lon');
                                var UniqueID = "weather_" + new Date().getTime().toString();
                                weatherElements[i].id = UniqueID;

                                var xhr = new XMLHttpRequest();
                                var url = 'http://api.openweathermap.org/data/2.5/weather?lat=' + lat + '&lon=' + lon + '&units=metric&APPID=8c5974c961ce95405a6d008676ca4555&';

                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState == 4 && xhr.status == 200) {
                                        onJsonLoad(xhr.responseText);
                                    }
                                };

                                xhr.open('GET', url, true);
                                xhr.send();
                            }
                        }
                    }
                },

                effort = function(timeID, effortID) {
                    var calorieContainer = document.querySelector("#" + effortID + " > p .calories");
                    var calorieRate = calorieContainer.getAttribute('data-calories') / 1440;
                    var calorieID = "cal_" + new Date().getTime().toString();
                    calorieContainer.id = calorieID;

                    var stepsContainer = document.querySelector("#" + effortID + " > p .steps");

                    var stepsRate = stepsContainer.getAttribute('data-steps') / 1440;
                    var stepID = "step_" + new Date().getTime().toString();
                    stepsContainer.id = stepID;

                    var timeAlapsed = document.getElementById(timeID).getAttribute('data-alapsed');

                    var caloriesBurnt = numberWithCommas(Math.round(calorieRate * timeAlapsed));

                    var stepsTaken = numberWithCommas(Math.round(stepsRate * timeAlapsed));

                    //set to display
                    document.getElementById(calorieID).innerHTML = caloriesBurnt;
                    document.getElementById(stepID).innerHTML = stepsTaken;
                };

            function numberWithCommas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            timezone();
            countup();
            weather();

        }());

        /*@cc_on
        (function(f){
         window.setTimeout =f(window.setTimeout);
         window.setInterval =f(window.setInterval);
        })(function(f){return function(c,t){var a=[].slice.call(arguments,2);return f(function(){c.apply(this,a)},t)}});
        @*/
    </script>
</body>

</html>